<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Xamplore â€“ Secure Exam</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
* {
  user-select: none;
  -webkit-user-select: none;
}
</style>
</head>

<body class="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 text-gray-800">

<nav class="bg-white shadow px-6 py-4">
  <h1 class="text-2xl font-bold text-emerald-700">Xamplore</h1>
</nav>

<section class="text-center py-10">
  <h2 class="text-3xl font-extrabold text-emerald-800">
    Smarter Exams for Smarter Students
  </h2>
  <p class="text-emerald-600 mt-2">Exam System for SRCAS</p>
</section>

<div class="flex justify-center pb-16">
  <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-xl">

    <!-- START -->
    <div id="start">
      <input id="nameInput" class="w-full p-2 mb-3 border rounded" placeholder="Your Name">
      <select id="patternSelect" class="w-full p-2 mb-3 border rounded">
        <option value="">Select Pattern</option>
        <option value="A">Pattern A</option>
        <option value="B">Pattern B</option>
        <option value="C">Pattern C</option>
      </select>
      <input id="passwordInput" type="password" class="w-full p-2 mb-4 border rounded" placeholder="Pattern Password">
      <button id="startBtn" class="w-full bg-emerald-600 text-white p-2 rounded font-semibold">
        Start Test
      </button>
    </div>

    <!-- TEST -->
    <div id="test" class="hidden">
      <div id="questionBox"></div>
      <button id="nextBtn" class="mt-4 w-full bg-emerald-600 text-white p-2 rounded">
        Next
      </button>
    </div>

    <!-- LOADING -->
    <div id="loading" class="hidden text-center">
      <p class="text-lg font-semibold text-emerald-700">Submitting answersâ€¦</p>
      <div class="mt-4 animate-spin h-8 w-8 border-4 border-emerald-600 border-t-transparent rounded-full mx-auto"></div>
    </div>

    <!-- RESULT -->
    <div id="result" class="hidden text-center">
      <h1 class="text-3xl font-bold text-emerald-700">Test Completed</h1>
      <p id="resultText" class="mt-3"></p>
      <button id="downloadBtn" class="mt-4 bg-emerald-600 text-white p-2 rounded">
        Download Answers PDF
      </button>
    </div>

  </div>
</div>

<script>
/* ================= DOM ================= */
const startDiv = document.getElementById("start");
const testDiv = document.getElementById("test");
const loadingDiv = document.getElementById("loading");
const resultDiv = document.getElementById("result");
const questionBox = document.getElementById("questionBox");

const nameInput = document.getElementById("nameInput");
const patternSelect = document.getElementById("patternSelect");
const passwordInput = document.getElementById("passwordInput");

const startBtn = document.getElementById("startBtn");
const nextBtn = document.getElementById("nextBtn");
const downloadBtn = document.getElementById("downloadBtn");
const resultText = document.getElementById("resultText");

/* ================= STATE ================= */
let examStarted = false;
let studentName = "";
let pattern = "";
let questions = [];
let index = 0;
let answers = [];

/* ================= SECURITY ================= */
function endTest(reason) {
  if (!examStarted) return;
  examStarted = false;
  document.body.innerHTML = `
    <div class="h-screen flex items-center justify-center text-center">
      <div>
        <h1 class="text-2xl font-bold text-red-600">Test Ended</h1>
        <p class="mt-2">${reason}</p>
      </div>
    </div>`;
}

document.addEventListener("visibilitychange", () => {
  if (examStarted && document.hidden) endTest("You left the test");
});

window.addEventListener("blur", () => {
  if (examStarted) endTest("Focus lost");
});

document.addEventListener("fullscreenchange", () => {
  if (examStarted && !document.fullscreenElement)
    endTest("Fullscreen exited");
});

document.addEventListener("copy", e => e.preventDefault());
document.addEventListener("contextmenu", e => e.preventDefault());

/* ================= QUESTIONS ================= */
const PASSWORDS = { A:"alpha123", B:"beta123", C:"gamma123" };

const QUESTION_BANK = {
  A:[
    {q:"Which keyword stores constants in JavaScript?",options:["var","let","const","static"],answer:"const"},
    {q:"Which HTML tag is used for navigation?",options:["div","nav","header","section"],answer:"nav"}
  ],
  B:[
    {q:"Which CSS unit is relative to viewport width?",options:["px","em","vh","vw"],answer:"vw"},
    {q:"Which function shows an alert box?",options:["prompt()","alert()","confirm()","log()"],answer:"alert()"}
  ],
  C:[
    {q:"Which method selects an element by ID?",options:["queryAll","getElement","getElementById","selectId"],answer:"getElementById"},
    {q:"Which tag runs JavaScript?",options:["js","script","code","javascript"],answer:"script"}
  ]
};

/* ================= FLOW ================= */
startBtn.onclick = () => {
  studentName = nameInput.value.trim();
  pattern = patternSelect.value;

  if (!studentName || !pattern || PASSWORDS[pattern] !== passwordInput.value)
    return alert("Invalid details");

  examStarted = true;
  questions = QUESTION_BANK[pattern];
  index = 0;
  answers = [];

  document.documentElement.requestFullscreen().catch(()=>{});
  startDiv.classList.add("hidden");
  testDiv.classList.remove("hidden");
  renderQuestion();
};

function renderQuestion(){
  const q = questions[index];
  questionBox.innerHTML =
    `<p class="mb-4 font-semibold">${q.q}</p>` +
    q.options.map(o =>
      `<label class="block mb-2">
        <input type="radio" name="ans" value="${o}"> ${o}
      </label>`).join("");
}

nextBtn.onclick = () => {
  const sel = document.querySelector("input[name='ans']:checked");
  if (!sel) return alert("Select an option");
  answers.push(sel.value);
  index++;

  if (index >= questions.length) submitExam();
  else renderQuestion();
};

/* ================= SUBMIT ================= */
function submitExam(){
  examStarted = false; // ðŸ”¥ SECURITY OFF
  document.exitFullscreen().catch(()=>{});

  testDiv.classList.add("hidden");
  loadingDiv.classList.remove("hidden");

  setTimeout(showResult, 3000); // â³ loading delay
}

function showResult(){
  loadingDiv.classList.add("hidden");
  resultDiv.classList.remove("hidden");

  const score = answers.filter((a,i)=>a===questions[i].answer).length;
  resultText.textContent = `${studentName} â€” Score: ${score}/${questions.length}`;
}

/* ================= PDF ================= */
downloadBtn.onclick = () => {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  let y = 10;

  pdf.text(`Name: ${studentName}`,10,y); y+=8;
  pdf.text(`Pattern: ${pattern}`,10,y); y+=10;

  questions.forEach((q,i)=>{
    pdf.text(`Q${i+1}: ${q.q}`,10,y); y+=6;
    pdf.text(`Your Answer: ${answers[i]}`,10,y); y+=6;
    pdf.text(`Correct Answer: ${q.answer}`,10,y); y+=8;
  });

  pdf.save(`${studentName}_Xamplore_Result.pdf`);
};
</script>

</body>
</html>
